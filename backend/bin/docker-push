#!/usr/bin/env bash
set -euo pipefail

################################################################################
# Docker Push Script
################################################################################
#
# OVERVIEW
# --------
# Pushes Link Radar backend image to GitHub Container Registry (GHCR).
#
# USAGE
# -----
#   bin/docker-push
#
# PREREQUISITES
# -------------
# - Local image must exist (run bin/docker-build first)
# - Authenticated with GHCR (repo is public, no auth needed for pull)
#
# PUSHES
# ------
# - ghcr.io/steveclarke/lr-backend:VERSION
# - ghcr.io/steveclarke/lr-backend:latest
#
################################################################################

script_dir=$(cd "$(dirname "$0")" && pwd)
source "${script_dir}/docker-config.sh"

################################################################################
# Core Functions
################################################################################

load_version() {
  get_version "${script_dir}"
}

verify_local_image() {
  local local_image="${IMAGE_NAME}:${version}"

  if ! docker image inspect "${local_image}" >/dev/null 2>&1; then
    error "Image ${local_image} not found. Run bin/docker-build first."
  fi

  info "Local image verified: ${local_image}"
}

tag_for_registry() {
  local local_image="${IMAGE_NAME}:${version}"
  local repo_version="${GHCR_REPO}:${version}"
  local repo_latest="${GHCR_REPO}:latest"

  log "Tagging ${local_image} for GHCR"

  docker tag "${local_image}" "${repo_version}"
  docker tag "${local_image}" "${repo_latest}"

  info "Tagged: ${repo_version}"
  info "Tagged: ${repo_latest}"
}

push_to_registry() {
  local repo_version="${GHCR_REPO}:${version}"
  local repo_latest="${GHCR_REPO}:latest"

  log "Pushing ${repo_version}"
  docker push "${repo_version}"

  log "Pushing ${repo_latest}"
  docker push "${repo_latest}"

  log "Push complete!"
}

show_success() {
  local repo_version="${GHCR_REPO}:${version}"
  local repo_latest="${GHCR_REPO}:latest"

  echo ""
  echo "Images pushed:"
  echo "  - ${repo_version}"
  echo "  - ${repo_latest}"
  echo ""
  echo "View on GitHub:"
  echo "  https://github.com/steveclarke/link-radar/pkgs/container/${IMAGE_NAME}"
  echo ""
}

################################################################################
# Main Orchestration
################################################################################

main() {
  load_version
  verify_local_image
  tag_for_registry
  push_to_registry
  show_success
}

################################################################################
# Script Execution
################################################################################

main "$@"
