#!/usr/bin/env bash

set -eo pipefail

# Docker build script for Link Radar backend
#
# Usage:
#   bin/docker-build                      # Builds for linux/amd64 (production)
#   bin/docker-build --local              # Builds for local platform (Mac/Linux dev)
#   bin/docker-build -- --no-cache        # Pass extra args to docker build
#
# By default, builds for linux/amd64 using buildx for production deployment.
# Use --local flag to build for your local platform (faster for local testing).

dirname=$(dirname -- "${0}")
script_dir=$(cd -- "${dirname}" >/dev/null 2>&1 && pwd)

source "${script_dir}/docker-helpers.sh"

# Get version from VERSION file
get_version "${script_dir}"

# Check for --local flag
local_build=false
if [ "$1" == "--local" ]; then
  local_build=true
  shift
fi

###
# Allow passing extra params through to the build command by using --
###
# Shift until we find --
while [ "$1" != "--" ] && [ -n "$1" ]; do
  shift
done

# Remove the --
if [ "$1" == "--" ]; then
  shift
fi

base_tag="lr-backend"
base_tag_with_version="${base_tag}:${version}"

log "Building ${base_tag_with_version}"
info "Build context: ${script_dir}/.."

# Change to backend directory for build
cd "${script_dir}/.."

# Build the image
if [ "$local_build" = true ]; then
  info "Building for local platform (faster, but won't work on linux/amd64 servers)"
  docker build -t "${base_tag_with_version}" "$@" .
else
  info "Building for linux/amd64 (production-ready)"
  docker buildx build --platform linux/amd64 --load -t "${base_tag_with_version}" "$@" .
fi

log "Build complete!"
info "Image: ${base_tag_with_version}"
echo ""
echo "Next steps:"
echo "  - Test the image: docker run --rm ${base_tag_with_version} bin/rails --version"
echo "  - Push to registry: bin/docker-push"

