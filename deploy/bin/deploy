#!/usr/bin/env bash

set -e

# Link Radar Production Deployment Script
# Automates deployment to a remote server via SSH

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${GREEN}==>${NC} ${1}"; }
info() { echo -e "${BLUE}Info:${NC} ${1}"; }
warn() { echo -e "${YELLOW}Warning:${NC} ${1}"; }
error() { echo -e "${RED}Error:${NC} ${1}" >&2; exit 1; }

# Usage
usage() {
  cat << EOF
Usage: bin/deploy [OPTIONS]

Automated deployment of Link Radar to a production server.

Required Environment Variables:
  DEPLOY_HOST          Server hostname or IP
  DEPLOY_USER          SSH user (default: deploy)
  RAILS_MASTER_KEY     Rails master key from backend/config/master.key
  DB_PASSWORD          PostgreSQL password
  GITHUB_TOKEN         GitHub token for GHCR access

Optional Environment Variables:
  BACKEND_IMAGE        Backend image (default: ghcr.io/steveclarke/lr-backend:latest)
  BACKEND_PORT         Backend port (default: 3000)

Options:
  -h, --help          Show this help message
  -c, --check         Check prerequisites only, don't deploy

Examples:
  # Set environment variables and deploy
  export DEPLOY_HOST=123.45.67.89
  export RAILS_MASTER_KEY=\$(cat ../backend/config/master.key)
  export DB_PASSWORD=\$(openssl rand -base64 32)
  export GITHUB_TOKEN=ghp_xxxxx
  bin/deploy

  # Or inline
  DEPLOY_HOST=123.45.67.89 \\
    RAILS_MASTER_KEY=xxx \\
    DB_PASSWORD=yyy \\
    GITHUB_TOKEN=zzz \\
    bin/deploy

EOF
  exit 0
}

# Parse arguments
CHECK_ONLY=false
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help) usage ;;
    -c|--check) CHECK_ONLY=true; shift ;;
    *) error "Unknown option: $1" ;;
  esac
done

# Check prerequisites
log "Checking prerequisites..."

# Required variables
[[ -z "${DEPLOY_HOST}" ]] && error "DEPLOY_HOST not set"
[[ -z "${RAILS_MASTER_KEY}" ]] && error "RAILS_MASTER_KEY not set"
[[ -z "${DB_PASSWORD}" ]] && error "DB_PASSWORD not set"
[[ -z "${GITHUB_TOKEN}" ]] && error "GITHUB_TOKEN not set"

# Optional with defaults
DEPLOY_USER="${DEPLOY_USER:-deploy}"
BACKEND_IMAGE="${BACKEND_IMAGE:-ghcr.io/steveclarke/lr-backend:latest}"
BACKEND_PORT="${BACKEND_PORT:-3000}"
GITHUB_USER="${GITHUB_USER:-steveclarke}"

info "Deploy host: ${DEPLOY_HOST}"
info "Deploy user: ${DEPLOY_USER}"
info "Backend image: ${BACKEND_IMAGE}"

# Test SSH connection
log "Testing SSH connection..."
if ! ssh -o ConnectTimeout=5 -o BatchMode=yes "${DEPLOY_USER}@${DEPLOY_HOST}" "echo 'SSH OK'" &>/dev/null; then
  error "Cannot connect to ${DEPLOY_USER}@${DEPLOY_HOST}. Check SSH access."
fi
log "SSH connection successful"

if [ "$CHECK_ONLY" = true ]; then
  log "Prerequisites check passed!"
  exit 0
fi

# Start deployment
log "Starting deployment to ${DEPLOY_HOST}..."
echo ""

# Step 1: Clone repository with sparse checkout
log "Step 1/7: Setting up deploy directory on server..."
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" bash << 'ENDSSH'
set -e
mkdir -p ~/docker
cd ~/docker

# Clone if not exists, otherwise update
if [ ! -d "link-radar" ]; then
  echo "Cloning repository..."
  git clone --filter=blob:none --sparse https://github.com/steveclarke/link-radar.git
  cd link-radar
  git sparse-checkout set deploy
else
  echo "Updating existing repository..."
  cd link-radar
  git fetch origin
  git reset --hard origin/master
fi

cd deploy
echo "Deploy directory ready: $(pwd)"
ENDSSH

# Step 2: Run setup script
log "Step 2/7: Running setup script..."
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" bash << 'ENDSSH'
cd ~/docker/link-radar/deploy
./bin/setup
ENDSSH

# Step 3: Configure environment files
log "Step 3/7: Configuring environment files..."

# Create .env
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" "cat > ~/docker/link-radar/deploy/.env" << EOF
# Link Radar Production Deployment Configuration
# Generated by automated deployment script

# Backend Docker Image
BACKEND_IMAGE=${BACKEND_IMAGE}

# Backend Port (external port mapping)
BACKEND_PORT=${BACKEND_PORT}
EOF

# Create backend.env
# URL-encode the password for use in DATABASE_URL
DB_PASSWORD_ENCODED=$(printf '%s' "${DB_PASSWORD}" | jq -sRr @uri)

ssh "${DEPLOY_USER}@${DEPLOY_HOST}" "cat > ~/docker/link-radar/deploy/env/backend.env" << EOF
# Link Radar Backend Configuration
# Generated by automated deployment script

# Rails Environment
RAILS_ENV=production
RAILS_LOG_LEVEL=info
RAILS_SERVE_STATIC_FILES=true

# Rails Master Key
RAILS_MASTER_KEY=${RAILS_MASTER_KEY}

# Database Configuration
DATABASE_URL=postgresql://linkradar:${DB_PASSWORD_ENCODED}@postgres:5432/linkradar_production

# Redis Configuration
REDIS_URL=redis://redis:6379/0

# Optional: Database connection pool size
RAILS_MAX_THREADS=5
EOF

# Create postgres.env
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" "cat > ~/docker/link-radar/deploy/env/postgres.env" << EOF
# PostgreSQL Database Configuration
# Generated by automated deployment script

POSTGRES_USER=linkradar
POSTGRES_PASSWORD=${DB_PASSWORD}
POSTGRES_DB=linkradar_production
EOF

log "Environment files configured"

# Step 4: Authenticate with GHCR
log "Step 4/7: Authenticating with GitHub Container Registry..."
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" bash << ENDSSH
echo "${GITHUB_TOKEN}" | docker login ghcr.io -u ${GITHUB_USER} --password-stdin
ENDSSH

# Step 5: Pull images
log "Step 5/7: Pulling Docker images..."
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" bash << 'ENDSSH'
cd ~/docker/link-radar/deploy
docker compose pull
ENDSSH

# Step 6: Start services
log "Step 6/7: Starting services..."
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" bash << 'ENDSSH'
cd ~/docker/link-radar/deploy
./bin/up
ENDSSH

# Wait for services to be healthy
log "Waiting for services to become healthy..."
sleep 10

# Step 7: Verify deployment
log "Step 7/7: Verifying deployment..."

# Check container status
info "Checking container status..."
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" bash << 'ENDSSH'
cd ~/docker/link-radar/deploy
docker compose ps
ENDSSH

# Test health endpoint
info "Testing health endpoint..."
if ssh "${DEPLOY_USER}@${DEPLOY_HOST}" "curl -f http://localhost:${BACKEND_PORT}/up" &>/dev/null; then
  log "Health check passed!"
else
  warn "Health check failed, but services may still be starting..."
fi

# Test database connection
info "Testing database connection..."
ssh "${DEPLOY_USER}@${DEPLOY_HOST}" bash << 'ENDSSH'
cd ~/docker/link-radar/deploy
./bin/runner bin/rails runner "puts 'DB: ' + (ActiveRecord::Base.connection.active? ? 'Connected' : 'Failed')"
ENDSSH

echo ""
log "ðŸŽ‰ Deployment complete!"
echo ""
echo "Your Link Radar backend is now running on ${DEPLOY_HOST}"
echo ""
echo "Next steps:"
echo "  - View logs: ssh ${DEPLOY_USER}@${DEPLOY_HOST} 'cd ~/docker/link-radar/deploy && ./bin/logs'"
echo "  - Check status: ssh ${DEPLOY_USER}@${DEPLOY_HOST} 'cd ~/docker/link-radar/deploy && docker compose ps'"
echo "  - Rails console: ssh ${DEPLOY_USER}@${DEPLOY_HOST} 'cd ~/docker/link-radar/deploy && ./bin/console'"
echo "  - Test: curl http://${DEPLOY_HOST}:${BACKEND_PORT}/up"
echo ""

